import streamlit as st
import joblib
import pandas as pd
import plotly.graph_objects as go

# --- PAGE CONFIGURATION ---
st.set_page_config(
    page_title="FloodGuard AI",
    page_icon="ğŸŒŠ",
    layout="wide"
)

# --- LOAD MODELS ---
try:
    alert_model = joblib.load('alert_model.pkl')
    location_encoder = joblib.load('location_encoder.pkl')
    sim_model = joblib.load('flood_model.pkl')
except:
    st.error("âš ï¸ Models not found. Please run 'train_all.py' first.")
    st.stop()

# --- HELPER FUNCTION: GAUGE CHART ---
def create_gauge(value, title):
    fig = go.Figure(go.Indicator(
        mode = "gauge+number",
        value = value,
        domain = {'x': [0, 1], 'y': [0, 1]},
        title = {'text': title},
        gauge = {
            'axis': {'range': [None, 100]},
            'bar': {'color': "darkblue"},
            'steps': [
                {'range': [0, 40], 'color': "#90ee90"}, # Green
                {'range': [40, 70], 'color': "#ffcc00"}, # Yellow
                {'range': [70, 100], 'color': "#ff4d4d"} # Red
            ],
            'threshold': {
                'line': {'color': "black", 'width': 4},
                'thickness': 0.75,
                'value': value
            }
        }
    ))
    fig.update_layout(height=300, margin=dict(l=20, r=20, t=50, b=20))
    return fig

# --- HEADER ---
st.title("ğŸŒŠ FloodGuard AI Intelligence")
st.markdown("### Advanced Flood Prediction & Early Warning System")
st.divider()

# --- TABS ---
tab1, tab2 = st.tabs(["ğŸŒ Global Early Warning", "ğŸ›ï¸ Risk Simulator"])

# ==========================================
# TAB 1: SEASONAL ALERTS (Historical Data)
# ==========================================
with tab1:
    col_a, col_b = st.columns([1, 2])
    
    with col_a:
        st.subheader("Select Parameters")
        st.info("Analyze historical data to predict seasonal risks.")
        
        # Location Input
        loc_input = st.selectbox("ğŸ“ Select Country/Region", location_encoder.classes_)
        
        # Month Input
        month_map = {1: "January", 2: "February", 3: "March", 4: "April", 
                     5: "May", 6: "June", 7: "July", 8: "August", 
                     9: "September", 10: "October", 11: "November", 12: "December"}
        month_input = st.selectbox("ğŸ“… Select Month", list(month_map.values()))
        month_num = list(month_map.keys())[list(month_map.values()).index(month_input)]
        
        btn_alert = st.button("Analyze Seasonal Risk")

    with col_b:
        if btn_alert:
            # Predict
            loc_code = location_encoder.transform([loc_input])[0]
            prediction = alert_model.predict_proba([[loc_code, month_num]])
            risk_percent = prediction[0][1] * 100
            
            # Display Gauge
            st.plotly_chart(create_gauge(risk_percent, f"Risk: {loc_input} in {month_input}"), use_container_width=True)
            
            # Display Message
            if risk_percent > 50:
                st.error(f"ğŸš¨ **High Alert:** Historical patterns show frequent flooding in {loc_input} during {month_input}.")
            elif risk_percent > 20:
                st.warning(f"âš ï¸ **Moderate Risk:** Flooding is possible based on past years.")
            else:
                st.success(f"âœ… **Safe Zone:** {month_input} is typically a dry season for {loc_input}.")

# ==========================================
# TAB 2: RISK SIMULATOR (Factors)
# ==========================================
with tab2:
    st.markdown("#### ğŸ›ï¸ Live Environmental Simulation")
    st.write("Adjust the sliders to simulate environmental conditions.")
    
    # 3 Columns for inputs
    c1, c2, c3 = st.columns(3)
    
    with c1:
        monsoon = st.slider("ğŸŒ§ï¸ Monsoon Intensity", 0, 10, 5)
        climate = st.slider("ğŸŒ¡ï¸ Climate Change", 0, 10, 5)
    with c2:
        deforestation = st.slider("ğŸŒ² Deforestation", 0, 10, 5)
        urbanization = st.slider("ğŸ™ï¸ Urbanization Rate", 0, 10, 5)
    with c3:
        river_mgmt = st.slider("ğŸš§ River Management", 0, 10, 5)
    
    # Predict Logic
    input_data = pd.DataFrame({
        'MonsoonIntensity': [monsoon],
        'Deforestation': [deforestation],
        'RiverManagement': [river_mgmt],
        'Urbanization': [urbanization],
        'ClimateChange': [climate]
    })
    
    st.divider()
    
    if st.button("Run Simulation"):
        pred = sim_model.predict(input_data)[0] * 100
        
        # Layout for result
        r1, r2 = st.columns([1, 1])
        
        with r1:
            st.plotly_chart(create_gauge(pred, "Real-Time Probability"), use_container_width=True)
            
        with r2:
            st.subheader("Analysis Report")
            if pred < 40:
                st.success("âœ… **Status: SAFE**\n\nCurrent factors indicate low flood risk.")
            elif pred < 65:
                st.warning("âš ï¸ **Status: CAUTION**\n\nRisk is elevated. Monitor conditions.")
            else:
                st.error("ğŸš¨ **Status: CRITICAL**\n\nHigh probability of severe flooding!")